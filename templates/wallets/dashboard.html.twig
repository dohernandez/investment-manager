{% extends 'base.html.twig' %}

{% block page_subtitle %}{{ wallet.name }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    {% include 'Components/Panel/panel-table-css.html.twig' %}

{#    <link rel="stylesheet" href="{{ asset('build/wallet_dashboard.css') }}">#}
    <link rel="stylesheet" href="{{ asset('build/wallet_dashboard.css') }}">
{% endblock %}

{% block page_content %}

    {% include 'wallets/partial/head-dashboard.html.twig' %}
    {% include 'wallets/partial/position-box.html.twig' %}
    {% include 'wallets/partial/dividend-box.html.twig' %}
    {% include 'wallets/partial/operation-box.html.twig' %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {% include 'Components/Panel/panel-table-scripts.html.twig' %}

    <script type="text/javascript"  src="{{ asset('build/wallet_dashboard.js') }}"></script>

    <script>
        $(document).ready(function() {
            const eventBus = window.eventBus;

            // Create position panel instance
            let $positionPanelBox = $('.js-position-panel-box');

            let positionContentWrapper = $positionPanelBox.closest('.js-position-panel');
            let positionEntityType = $positionPanelBox.data('entity-type');

            const searchFuncPanel = function (entities, search) {
                if (search.length >= 2) {
                    let $matches = [];

                    search = search.toUpperCase();

                    $.each(entities, function (index, entity) {
                        if (entity.stock) {
                            if (entity.stock.name.toUpperCase().indexOf(search) > -1 ||
                                entity.stock.symbol.toUpperCase().indexOf(search) > -1 ) {

                                $matches.push(entity);
                            }
                        }
                    });

                    return $matches;
                }

                return null;
            };


            // Create panelTable instance @see assets/js/PanelTable.js
            let positionPanelTable = new PanelTable({
                entityType: positionEntityType,
                wrapper: positionContentWrapper,
                pagination: false,
                selectors: {
                    searchTemplate: '#js-table-{{ wallet_position_entity_name|lower|replace({' ': '_'}) }}-search-template',
                    showPerPageTemplate: '#js-table-{{ wallet_position_entity_name|lower|replace({' ': '_'}) }}-show-per-page-template',
                    rowTemplate: '#js-table-{{ wallet_position_entity_name|lower|replace({' ': '_'}) }}-row-template',
                },
                sort: function (aPosition, bPosition) {
                    let a = aPosition.stock.name;
                    let b = bPosition.stock.name;

                    return a < b ? -1 : a > b ? 1 : 0;
                },
                searchFunc: searchFuncPanel,
                afterSearchFunc: function (search) {
                    eventBus.emit('position_searched', null, search);
                },
                afterCleanSearchFunc: function () {
                    eventBus.emit('position_search_cleaned', null);
                }
            });

            // create stock note form
            const positionStockNoteswalOptions = window.StockNoteswalOptions;

            // It is use PositionStockNoteForm which translate the position into stock and vise-versa
            const stockNoteForm = new PositionStockNoteForm(
                positionStockNoteswalOptions,
                positionPanelTable,
                '#js-panel-{{ stock_note_entity_name|lower|replace({' ': '_'}) }}-form-template',
            );

            const positionStockNoteButtonSwalOptions = {
                options: positionStockNoteswalOptions.editView,
                onBeforeOpen: stockNoteForm.onBeforeOpenEditView.bind(stockNoteForm),
                confirmButtonText: positionStockNoteswalOptions.text.update.confirmButtonText,
                titleText: positionStockNoteswalOptions.text.update.titleText,
                confirmTitleText: positionStockNoteswalOptions.text.update.confirmTitleText,
            };
            positionStockNoteButtonSwalOptions.options.width = 800;

            const stockNoteRowButton = new StockNoteRowButton(
                stockNoteForm,
                positionStockNoteButtonSwalOptions,
                function (id) {
                    console.log(id);
                },
                '.js-stock-note',
            );
            positionPanelTable.addRowButton(stockNoteRowButton);


            // Create dividend panel instance
            let $dividendPanelBox = $('.js-position-dividend-panel-box');

            let dividendContentWrapper = $dividendPanelBox.closest('.js-dividend-panel');
            let dividendEntityType = $dividendPanelBox.data('entity-type');

            // Create panelTable instance @see assets/js/PanelTable.js
            let dividendPanelTable = new PanelTable({
                entityType: dividendEntityType,
                wrapper: dividendContentWrapper,
                pagination: false,
                selectors: {
                    searchTemplate: '#js-table-{{ wallet_position_dividend_entity_name|lower|replace({' ': '_'}) }}-search-template',
                    showPerPageTemplate: '#js-table-{{ wallet_position_dividend_entity_name|lower|replace({' ': '_'}) }}-show-per-page-template',
                    rowTemplate: '#js-table-{{ wallet_position_dividend_entity_name|lower|replace({' ': '_'}) }}-row-template',
                },
                sort: function (aPosition, bPosition) {
                    let a = aPosition.stock.name;
                    let b = bPosition.stock.name;

                    return a < b ? -1 : a > b ? 1 : 0;
                },
                searchFunc: searchFuncPanel,
                showSearchBox: false,
            });

            const PositionDividendswalOptions = window.PositionDividendswalOptions;

            // dividend form
            const dividendForm = new PositionDividendForm(
                PositionDividendswalOptions,
                dividendPanelTable,
                '#js-panel-{{ wallet_position_dividend_entity_name|lower|replace({' ': '_'}) }}-form-template',
            );

            const dividendRetentionRowButton = new PositionDividendRowButton(
                dividendForm,
                {
                    options: PositionDividendswalOptions.editView,
                    onBeforeOpen: dividendForm.onBeforeOpenEditView.bind(dividendForm),
                    confirmButtonText: PositionDividendswalOptions.text.update.confirmButtonText,
                    titleText: '{{ 'Update dividend retention'|trans }}',
                    confirmTitleText: '{{ 'Dividend retention was deleted successfully.'|trans }}',
                },
                '.js-position-dividend-retention',
                function (id) {
                    return Routing.generate(
                        'wallet_{{ wallet_position_dividend_entity_name|lower|replace({' ': '_'}) }}_retention',
                        {
                            '_id': {{ wallet.id }},
                            id,
                        }
                    );
                }
            );
            dividendPanelTable.addRowButton(dividendRetentionRowButton);


            // Create dividend panel instance
            let $operationPanelBox = $('.js-operation-panel-box');

            let operationContentWrapper = $operationPanelBox.closest('.js-operation-panel');
            let operationEntityType = $operationPanelBox.data('entity-type');

            // Create panelTable instance @see assets/js/PanelTable.js
            let operationPanelTable = new PanelTable({
                entityType: operationEntityType,
                wrapper: operationContentWrapper,
                pagination: true,
                selectors: {
                    searchTemplate: '#js-table-{{ wallet_operation_entity_name|lower|replace({' ': '_'}) }}-search-template',
                    showPerPageTemplate: '#js-table-{{ wallet_operation_entity_name|lower|replace({' ': '_'}) }}-show-per-page-template',
                    rowTemplate: '#js-table-{{ wallet_operation_entity_name|lower|replace({' ': '_'}) }}-row-template',
                },
                sort: function (aOperation, bOperation) {
                    let a = new Date(aOperation.dateAt);
                    let b = new Date(bOperation.dateAt);

                    return a > b ? -1 : a < b ? 1 : 0;
                },
                searchFunc: searchFuncPanel,
                showSearchBox: false,
            });

            const OperationswalOptions = window.OperationswalOptions;
            const urlCreateOperation = Routing.generate(
                'wallet_{{ wallet_operation_entity_name|lower|replace({' ': '_'}) }}_new',
                {'_id': {{ wallet.id }}}
            );
            const createOperationEventName = 'entity_operation_created';

            // create operation form
            const operationForm = new OperationForm(
                OperationswalOptions,
                operationPanelTable,
                '#js-panel-{{ wallet_operation_entity_name|lower|replace({' ': '_'}) }}-form-template',
            );

            const createButton = new CreateButton(
                '{{ 'Create new'|trans }} {{ wallet_operation_entity_name|trans|lower }}',
                operationForm,
                function () {
                    return urlCreateOperation;
                },
                '.js-entity-create',
                '.js-panel-header-button-container',
                createOperationEventName
            );
            operationPanelTable.addButton(createButton);

            // Setting the relation with the same form as the operation panel.
            positionPanelTable.addButton(createButton);

            const swalOptionsCreateOperation = {
                options: OperationswalOptions.editView,
                onBeforeOpen: operationForm.onBeforeOpenEditView.bind(operationForm),
                confirmButtonText: OperationswalOptions.text.create.confirmButtonText,
                titleText: OperationswalOptions.text.create.titleText,
                confirmTitleText: OperationswalOptions.text.create.confirmTitleText,
            };

            $.each(['dividend', 'buy', 'sell'], function (index, type) {
                const positionDividendRowButton = new PositionOperationRowButton(
                    operationForm,
                    swalOptionsCreateOperation,
                    type,
                    urlCreateOperation,
                    createOperationEventName
                );
                positionPanelTable.addRowButton(positionDividendRowButton);
            });


            // Create dividend panel instance
            let $comingDividendsPanelBox = $('.js-coming-dividends-panel-box');

            let comingDividendsContentWrapper = $comingDividendsPanelBox.closest('.js-coming-dividends-panel');
            let comingDividendsEntityType = $comingDividendsPanelBox.data('entity-type');

            // Create panelTable instance @see assets/js/PanelTable.js
            let comingDividendsPanelTable = new PanelTable({
                entityType: comingDividendsEntityType,
                wrapper: comingDividendsContentWrapper,
                pagination: false,
                selectors: {
                    searchTemplate: '#js-table-{{ wallet_coming_dividend_entity_name|lower|replace({' ': '_'}) }}-search-template',
                    showPerPageTemplate: '#js-table-{{ wallet_coming_dividend_entity_name|lower|replace({' ': '_'}) }}-show-per-page-template',
                    rowTemplate: '#js-table-{{ wallet_coming_dividend_entity_name|lower|replace({' ': '_'}) }}-row-template',
                },
                sort: function (aPosition, bPosition) {
                    // Hack to send those stocks do not have dividend to the end of the list.
                    // When exDate is null the date created is 1970-01-01. In order to send those date to the end of the list
                    // the date is set to 4019-10-03.
                    let a = aPosition.stock.exDate !== null ? new Date(aPosition.stock.exDate) : new Date('4019-10-03');
                    let b = bPosition.stock.exDate !== null ? new Date(bPosition.stock.exDate) : new Date('4019-10-03');

                    return a < b ? -1 : a > b ? 1 : 0;
                },
                limit: 5,
            });

            let panel = new WalletDashboard(
                {{ wallet.id }},
                positionPanelTable,
                dividendPanelTable,
                operationPanelTable,
                comingDividendsPanelTable
            );

            panel.render();
            panel.load();

            // Tweak button toggle main menu to show/hide columns
            $('.sidebar-toggle').on(
                'click',
                function(e) {
                    let $button = $(e.currentTarget);

                    if ($button.data('toggle') === 'push-menu') {
                        panel.toggleExpanded();
                    }
                }
            );
        });
    </script>

{% endblock %}
