{#
    new_url => url to create a new entity
    entity_name => entity name
#}

{% extends 'base.html.twig' %}

{% import 'Components/Macros/ajax-render.html.twig' as render %}

{% block page_content %}
    <div class="row">
        <div class="col-md-12">
            <div class="box">
                <div class="box-header with-border">
                    <a href="{{ new_url|default('#') }}" class="entity-create btn btn-success pull-right" data-target="#modal-create"
                       data-toggle="modal">
                        <i class="fa-plus-circle fa" aria-hidden="true"></i> Create new {{ entity_name|trans|lower }}</a>
                </div>
                <div class="box-body table-responsive no-padding">
                    {# Printing success message. This section makes sense when creating/updating/deleteing entity. #}
                    {% for message in app.flashes('success') %}
                        {%  include 'Components/Alerts/alert-message.html.twig' with {
                            'message_type': 'success',
                            'message': message
                        }%}
                    {% endfor %}

                    {# Printing error message. This section makes sense when creating/updating/deleteing entity. #}
                    {% for message in app.flashes('error') %}
                        {%  include 'Components/Alerts/alert-message.html.twig' with {
                            'message_type': 'danger',
                            'message': message
                        }%}
                    {% endfor %}

                    {% set modal = null %}
                    <table id="{{ entity_name|trans|lower|trim(' ') }}s" class="table table-bordered table-striped js-manager-table">
                        <thead>
                        <tr>
                            <th width="60" class="text-center" scope="col">#</th>
                            {% for field in fields %}
                                <th {% if field.col_with is defined %} width="{{ field.col_with }}" {% endif %} scope="col">
                                    {% if field.label is not defined %}{{ field.name|trans|upper }}{% else %}{{ field.label|trans|upper }}{% endif %}
                                </th>
                            {% endfor %}
                            <th width="{% if buttons is defined %}{{ buttons|length * 22 + 100 }}{% else %}100{% endif %}" scope="col">MANAGE</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                    {% embed 'Components/Modal/modal.html.twig' with {
                        'dialog' : 'confirm-delete-dialog',
                        'request' : 'true',
                        'modal_id' : 'modal-delete',
                        'modal_title_id': 'modalTitleDelete'
                    } %}
                    {% endembed %}

                    {% if modal %}
                        {% embed 'Components/Modal/modal.html.twig' with {
                            'dialog' : 'loading-dialog',
                            'modal_id' : 'modal-show',
                            'modal_title_id': 'modalTitleDelete'
                        } %}
                        {% endembed %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% set modal_title %}
        <h4 class="modal-title">Create new {{ entity_name|trans|lower }}</h4>
    {% endset %}

    {% set modal_body %}
        {% embed 'Components/Layout/_box.html.twig'%}
            {% block _box %}
                {% include 'Components/Form/_form-horizontal.html.twig' with {
                    'form': form,
                    'box_type': 'success',
                    'submit_icon': 'save',
                    'submit_type': 'Create',
                    'data_model': 'data-dismiss=modal'
                } %}
            {% endblock %}
        {% endembed %}
    {% endset %}

    {% embed 'Components/Modal/modal.html.twig' with {
        'dialog' : 'dialog',
        'modal_id' : 'modal-create',
        'request' : 'true',
        'modal_title': modal_title,
        'modal_body': modal_body
    } %}
    {% endembed %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <!-- row table template -->
    <script type="text/template" id="js-manager-row-template">
        <tr>
            <th style="vertical-align: middle;" scope="row" class="text-center js-manager-row-index"><%= index %></th>
            {% for field in fields %}
                <td style="vertical-align: middle;">
                    {{ render.field(field.name, field) }}
                </td>
            {% endfor %}
            <td>
                <a href=""  style="margin-left: 3px"
                   class="btn btn-primary btn-sm pull-left">
                    <i class="fa fa-pencil-alt" aria-hidden="true"></i>
                </a>
                <button type="button" data-backdrop="static" data-keyboard="false" class="entity-delete btn btn-danger btn-sm" data-target="#modal-delete"
                        data-keyboard="true" data-toggle="modal" data-id="<%= id %>" data-title="<%= title %>"
                        data-url="<%= Routing.generate('transfer_delete', {'id': id}) %>"   style="margin-left: 3px">
                    <i class="fa-trash-alt fa" aria-hidden="true"></i>
                </button>
            </td>
        </tr>
    </script>

    <script>
        $(document).ready(function(){
            // Create crud manager instance.
            // The instance will take care of add, update and remove entities and keep the table updated.
            let $wrapper = $('.js-manager-table');
            let $modal = $('#modal-delete');
            let crudManagertable = new CRUDManageTable($wrapper, $modal);

            // Implementation create button on modal
            $(document).on("click", ".entity-create", function () {
                $('#background-modal-create').hide();

                var form = $('#entity-form');
                form.trigger("reset");

                // As pointed out in comments,
                // it is superfluous to have to manually call the modal.
                var modal = $('#modal-create');
                modal.modal('show');

                modal.modal({ backdrop: 'static', keyboard: false })
                    .on('click', '#submit-btn', function(){
                        form.submit();

                        // Block the panel
                        modal.modal({backdrop: 'static', keyboard: false});
                        $('#modal-create .modal-dialog').hide();
                        modal.css('text-align','center');

                        $('#background-modal-create').show();
                    });
            });
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>

    <script src="{{ asset('bundles/fosjsrouting/js/router.min.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>

    <script src="{{ asset('assets/js/table/crud-manage-table.js') }}"></script>
{% endblock %}

